ORG $1000

define TTY_OUT $0100
define TTY_IN $0120
define CPU_STOP $0110

DATA {
INTERRUPT_COUNT:
  DB $0
INTERRUPT_MAX:
  DB 26
INTERRUPT_IN:
  DB $0
}

CODE {
  LDX #$FF
	TXS

  CLI

MAIN:
  LDA INTERRUPT_IN
  CMP #0
  BEQ *IN_NO

  JSR PUT_CHAR
  CLI
IN_NO:
  LDA INTERRUPT_COUNT
  CMP INTERRUPT_MAX
  BCC *MAIN

  JMP EXIT

SEG PUT_CHAR

EXIT:
  LDA #1
  STA CPU_STOP
  JMP EXIT
}

IRQ {
  SEI
  LDA #1
  STA INTERRUPT_IN
  RTI
}

PUT_CHAR {
PUT_CHAR:
  LDA TTY_IN
  STA TTY_OUT
WAIT_FOR_ACK:
  LDA TTY_OUT
  CMP #0
	BNE *WAIT_FOR_ACK
  STA INTERRUPT_IN
	INC INTERRUPT_COUNT
  RTS
}
